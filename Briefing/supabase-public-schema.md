-- WARNING: This schema is for reference only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.admin (
  admin_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  username text NOT NULL UNIQUE,
  password_hash text NOT NULL,
  last_login_at timestamp with time zone,
  session_data jsonb,
  email character varying,
  role character varying DEFAULT 'admin'::character varying CHECK (role::text = ANY (ARRAY['super_admin'::character varying, 'admin'::character varying, 'support'::character varying, 'viewer'::character varying]::text[])),
  CONSTRAINT admin_pkey PRIMARY KEY (admin_id)
);
CREATE TABLE public.customers (
  customer_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  full_name character varying NOT NULL,
  email_address text NOT NULL UNIQUE,
  phone_number character varying NOT NULL,
  payment_status USER-DEFINED NOT NULL DEFAULT 'pending'::payment_status_enum,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  ip_address inet,
  user_agent text,
  acquisition_source character varying,
  acquisition_campaign character varying,
  referrer_url text,
  utm_source character varying,
  utm_medium character varying,
  utm_campaign character varying,
  utm_term character varying,
  utm_content character varying,
  email_verified boolean DEFAULT false,
  notes text,
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT customers_pkey PRIMARY KEY (customer_id)
);
CREATE TABLE public.email_logs (
  log_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  customer_id uuid,
  order_id uuid,
  email_type character varying NOT NULL,
  recipient_email character varying NOT NULL,
  subject character varying,
  status character varying NOT NULL DEFAULT 'queued'::character varying,
  provider character varying DEFAULT 'mailjet'::character varying,
  provider_message_id character varying,
  provider_response jsonb,
  sent_at timestamp with time zone,
  delivered_at timestamp with time zone,
  opened_at timestamp with time zone,
  clicked_at timestamp with time zone,
  error_code character varying,
  error_message text,
  retry_count integer DEFAULT 0,
  next_retry_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_logs_pkey PRIMARY KEY (log_id),
  CONSTRAINT email_logs_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id),
  CONSTRAINT email_logs_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id)
);
CREATE TABLE public.orders (
  order_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  customer_id uuid NOT NULL,
  order_number text NOT NULL UNIQUE,
  order_date timestamp with time zone NOT NULL DEFAULT now(),
  total_amount numeric NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  product_id uuid,
  product_name character varying NOT NULL DEFAULT 'Digital Product'::character varying,
  product_version character varying,
  product_price numeric NOT NULL DEFAULT 0.00,
  discount_amount numeric DEFAULT 0,
  final_amount numeric NOT NULL DEFAULT 0.00,
  currency_code character DEFAULT 'MYR'::bpchar,
  order_status character varying DEFAULT 'pending'::character varying,
  payment_method character varying DEFAULT 'fpx'::character varying,
  payment_gateway character varying DEFAULT 'securepay'::character varying,
  gateway_transaction_id character varying,
  order_source character varying DEFAULT 'website'::character varying,
  email_sent boolean DEFAULT false,
  email_sent_at timestamp with time zone,
  refund_status character varying DEFAULT 'none'::character varying,
  refund_amount numeric,
  refund_reason text,
  refund_processed_at timestamp with time zone,
  order_notes text,
  CONSTRAINT orders_pkey PRIMARY KEY (order_id),
  CONSTRAINT orders_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id)
);
CREATE TABLE public.payment_sessions (
  session_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  customer_id uuid,
  order_id uuid,
  session_token character varying NOT NULL UNIQUE,
  checkout_data jsonb NOT NULL,
  session_status character varying DEFAULT 'active'::character varying,
  gateway_session_id character varying,
  gateway_payment_url text,
  gateway_callback_data jsonb,
  ip_address inet NOT NULL,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  completed_at timestamp with time zone,
  attempts integer DEFAULT 0,
  last_attempt_at timestamp with time zone,
  checksum character varying,
  CONSTRAINT payment_sessions_pkey PRIMARY KEY (session_id),
  CONSTRAINT payment_sessions_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id),
  CONSTRAINT payment_sessions_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id)
);
CREATE TABLE public.settings (
  setting_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  setting_key character varying NOT NULL UNIQUE,
  setting_value jsonb NOT NULL,
  setting_type character varying NOT NULL,
  description text,
  is_public boolean DEFAULT false,
  updated_at timestamp with time zone DEFAULT now(),
  updated_by uuid,
  CONSTRAINT settings_pkey PRIMARY KEY (setting_id),
  CONSTRAINT settings_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.admin(admin_id)
);
CREATE TABLE public.webhook_logs (
  webhook_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  provider character varying NOT NULL,
  event_type character varying NOT NULL,
  request_headers jsonb,
  request_body jsonb,
  request_signature character varying,
  signature_valid boolean,
  ip_address inet,
  processing_status character varying DEFAULT 'pending'::character varying,
  processed_at timestamp with time zone,
  response_status integer,
  response_body jsonb,
  error_message text,
  retry_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT webhook_logs_pkey PRIMARY KEY (webhook_id)
);