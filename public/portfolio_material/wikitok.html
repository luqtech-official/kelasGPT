<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WikiTok ‚Äì Knowledge, but make it scroll</title>
  <meta name="description" content="A premium, minimal, TikTok‚Äëstyle Wikipedia discovery app built with vanilla HTML/CSS/JS." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Ctext y='0.9em' font-size='200'%3Eüìö%3C/text%3E%3C/svg%3E" />
  <style>
    /* ---------------------------------------------------------
       THEME: Sophisticated dark, premium minimal aesthetic
       --------------------------------------------------------- */
    :root {
      --bg: #0a0a0a;
      --bg-elev: #111111;
      --text: #ffffff;
      --muted: #cfcfcf;
      --line: #1f1f1f;
      --accent: #4a90e2;    /* muted blue */
      --accent-warm: #f39c12; /* warm amber */
      --good: #7bd88f;
      --warn: #ffd166;
      --danger: #ff6b6b;

      --radius: 18px;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --shadow-soft: 0 2px 12px rgba(0,0,0,.25);

      --font-sans: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, "SF Pro Text", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

      --gap: 16px;
      --gap-lg: 24px;
      --max-width: 860px;
    }

    @media (prefers-color-scheme: dark) {
      :root { color-scheme: dark; }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 20% -10%, #141414 0%, #0b0b0b 40%, #0a0a0a 80%) fixed;
      color: var(--text);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ---------------------------------------------------------
       LAYOUT
       --------------------------------------------------------- */
    header.appbar {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 86%, transparent);
      border-bottom: 1px solid var(--line);
    }
    .appbar-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 12px var(--gap);
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: var(--gap);
      align-items: center;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .brand .logo {
      width: 30px; height: 30px;
      display: grid; place-items: center;
      background: linear-gradient(135deg, var(--accent) 0%, #85b8ff 100%);
      border-radius: 8px;
      color: #06111d;
      font-size: 18px;
      font-weight: 900;
      box-shadow: var(--shadow-soft);
    }
    .brand .title { font-size: 16px; }

    .searchbar {
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
    }
    .searchbar input[type="search"] {
      width: 100%;
      background: var(--bg-elev);
      border: 1px solid var(--line);
      padding: 12px 44px 12px 14px;
      color: var(--text);
      border-radius: 12px;
      outline: none;
    }
    .search-wrap { position: relative; }
    .search-wrap svg { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); opacity: .65; }

    .cta-row { display: inline-flex; gap: 8px; }

    button, .chip {
      font: inherit; color: var(--text);
      background: var(--bg-elev);
      border: 1px solid var(--line);
      padding: 10px 12px; border-radius: 999px;
      cursor: pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }
    button:hover, .chip:hover { background: #151515; }
    button:active { transform: translateY(1px); }
    button:focus-visible, .chip:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .chip {
      background: transparent; border-color: #2a2a2a; opacity: .9;
    }
    .chip[data-active="true"] { background: #171717; border-color: #3a3a3a; opacity: 1; }

    .filters {
      max-width: var(--max-width);
      margin: 6px auto 4px;
      padding: 0 var(--gap) 8px;
      display: flex; flex-wrap: wrap; gap: 8px;
    }

    main#feed {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--gap);
      display: grid;
      gap: var(--gap-lg);
    }

    /* ---------------------------------------------------------
       CARD
       --------------------------------------------------------- */
    article.card {
      position: relative;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
      min-height: min(92vh, 920px);
      display: grid;
      grid-template-rows: auto 1fr auto;
      outline: none;
    }

    .card .media { position: relative; aspect-ratio: 16/9; background: #0e0e0e; }

    .skeleton {
      position: absolute; inset: 0; border-radius: 0;
      background: linear-gradient(90deg, #131313, #1a1a1a, #131313);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite linear;
    }
    @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

    /* Placeholder styles for articles without images */
    .placeholder {
      position: absolute; inset: 0; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: rgba(255,255,255,0.6); text-align: center; padding: 20px;
    }
    .placeholder-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.8; }
    .placeholder-text { font-size: 14px; font-weight: 500; letter-spacing: 0.3px; }

    /* Category-specific gradients */
    .placeholder.science { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #1e1b4b 100%); }
    .placeholder.history { background: linear-gradient(135deg, #92400e 0%, #d97706 50%, #451a03 100%); }
    .placeholder.technology { background: linear-gradient(135deg, #065f46 0%, #059669 50%, #022c22 100%); }
    .placeholder.culture { background: linear-gradient(135deg, #7c2d12 0%, #dc2626 50%, #450a0a 100%); }
    .placeholder.people { background: linear-gradient(135deg, #5b21b6 0%, #8b5cf6 50%, #2d1b69 100%); }
    .placeholder.places { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 50%, #042f2e 100%); }
    .placeholder.discover { background: linear-gradient(135deg, #374151 0%, #6b7280 50%, #1f2937 100%); }

    .card picture, .card img {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }

    .content { padding: 18px; display: grid; gap: 8px; }
    .title { font-size: clamp(22px, 3vw, 30px); line-height: 1.2; margin: 0; letter-spacing: .2px; }
    .subtitle { color: var(--muted); font-size: 14px; margin: 0; }
    .extract { color: #e7e7e7; line-height: 1.6; font-size: 16px; }

    .meta {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
      border-top: 1px solid var(--line);
      margin-top: 10px; padding-top: 10px;
      font-size: 14px; color: var(--muted);
    }
    .meta a { color: var(--accent); text-decoration: none; }
    .meta .tag { background: #141414; border: 1px solid #2a2a2a; padding: 6px 10px; border-radius: 999px; font-size: 12px; letter-spacing: .2px; }

    .actions {
      position: absolute; right: 14px; bottom: 14px;
      display: grid; gap: 10px;
    }
    .iconbtn {
      width: 46px; height: 46px; border-radius: 50%; display: grid; place-items: center;
      background: #151515; border: 1px solid #2a2a2a; box-shadow: var(--shadow-soft);
    }
    .iconbtn[aria-pressed="true"] { background: #0f1b2a; border-color: #213452; }
    .iconbtn svg { width: 22px; height: 22px; }

    .toast {
      position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
      background: #101010; border: 1px solid #242424; padding: 12px 16px; border-radius: 12px; box-shadow: var(--shadow);
      font-size: 14px; color: var(--text);
      opacity: 0; pointer-events: none; transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }

    .empty { text-align: center; color: var(--muted); padding: 40px 0; }

    /* Keyboard hint at bottom right */
    .kbd-hints {
      position: fixed; right: 12px; bottom: 12px; z-index: 40; opacity: .75; font-size: 12px;
      color: var(--muted);
      background: #0e0e0e; border: 1px solid #252525; border-radius: 10px; padding: 6px 10px;
    }
    kbd { background: #1a1a1a; border: 1px solid #2a2a2a; padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }

    /* Preferences modal */
    dialog#prefs {
      border: 1px solid #2a2a2a; border-radius: 16px; background: #0f0f0f; color: var(--text);
      width: min(640px, 92vw); padding: 0; overflow: hidden; box-shadow: var(--shadow);
    }
    dialog::backdrop { backdrop-filter: blur(2px); background: rgba(0,0,0,.4); }
    .modal-head { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--line); }
    .modal-body { padding: 14px 16px; display: grid; gap: 12px; }
    .pref-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }

    .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <a href="#feed" class="sr-only">Skip to feed</a>
  <header class="appbar" role="banner">
    <div class="appbar-inner">
      <div class="brand" aria-label="WikiTok">
        <div class="logo" aria-hidden="true">W</div>
        <div class="title">WikiTok</div>
      </div>

      <form class="searchbar" role="search" id="search-form" autocomplete="off">
        <div class="search-wrap">
          <input id="search" name="q" type="search" placeholder="Search Wikipedia topics (press /)" aria-label="Search Wikipedia topics" />
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3" stroke="#9f9f9f" stroke-width="1.6" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#9f9f9f" stroke-width="1.6"/></svg>
        </div>
        <div class="cta-row">
          <button type="button" id="random-btn" class="chip" title="Random article (r)">Random</button>
          <button type="button" id="prefs-btn" class="chip" aria-haspopup="dialog">Preferences</button>
          <button type="button" id="saved-btn" class="chip" title="Saved articles">Saved</button>
        </div>
      </form>

    </div>
    <nav class="filters" aria-label="Categories">
      <button class="chip" data-category="For You" data-active="true">For You</button>
      <button class="chip" data-category="Science">Science</button>
      <button class="chip" data-category="History">History</button>
      <button class="chip" data-category="Technology">Technology</button>
      <button class="chip" data-category="Culture">Culture</button>
      <button class="chip" data-category="People">People</button>
      <button class="chip" data-category="Places">Places</button>
    </nav>
  </header>

  <main id="feed" role="feed" aria-live="polite"></main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div class="kbd-hints">Space: next ‚Ä¢ Shift+Space: prev ‚Ä¢ <kbd>L</kbd> like ‚Ä¢ <kbd>B</kbd> save ‚Ä¢ <kbd>/</kbd> search ‚Ä¢ <kbd>R</kbd> random</div>

  <!-- Preferences Modal -->
  <dialog id="prefs" aria-labelledby="prefs-title" aria-describedby="prefs-desc">
    <div class="modal-head">
      <h2 id="prefs-title" style="margin:0;font-size:18px;">Preferences</h2>
      <button id="prefs-close" class="chip">Close</button>
    </div>
    <div class="modal-body">
      <p id="prefs-desc" class="subtitle">Choose your preferred content categories. Your For You feed learns from likes and saves.</p>
      <div class="pref-grid" id="pref-grid"></div>
      <label style="display:flex;align-items:center;gap:10px;margin-top:8px;">
        <input type="checkbox" id="pref-reduced-motion" /> Respect reduced motion (if unchecked, minimal animations may play)
      </label>
    </div>
  </dialog>

  <template id="card-template">
    <article class="card" role="article" aria-busy="true" tabindex="0">
      <div class="media">
        <div class="skeleton" aria-hidden="true"></div>
      </div>
      <div class="content">
        <h2 class="title">Loading‚Ä¶</h2>
        <p class="subtitle">Curating knowledge</p>
        <p class="extract">Hang tight while we fetch a great snippet from Wikipedia.</p>
        <div class="meta">
          <span class="tag">Discover</span>
          <span class="source">Source: Wikipedia</span>
        </div>
      </div>
      <div class="actions">
        <button class="iconbtn like" aria-label="Like" aria-pressed="false" title="Like (L)">
          <svg viewBox="0 0 24 24" fill="none" stroke="#e7e7e7" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1L12 22l7.8-8.6 1-1a5.5 5.5 0 0 0 0-7.8z"/></svg>
        </button>
        <button class="iconbtn save" aria-label="Save" aria-pressed="false" title="Save (B)">
          <svg viewBox="0 0 24 24" fill="none" stroke="#e7e7e7" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
        </button>
        <button class="iconbtn share" aria-label="Share" title="Share">
          <svg viewBox="0 0 24 24" fill="none" stroke="#e7e7e7" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.6 13.5l6.8 3.9M15.4 6.6L8.6 10.5"/></svg>
        </button>
      </div>
    </article>
  </template>

  <script type="module">
    /* =========================================================
       "storage.js" ‚Äî localStorage/sessionStorage management
       ========================================================= */
    const LS = {
      get(key, fallback) {
        try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; }
      },
      set(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch {} },
      sget(key, fallback) { try { const v = sessionStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch { return fallback; } },
      sset(key, value) { try { sessionStorage.setItem(key, JSON.stringify(value)); } catch {} },
    };

    const Storage = {
      keys: {
        likes: 'wikitok.likes',
        saves: 'wikitok.saves',
        history: 'wikitok.history',
        prefs: 'wikitok.prefs',
        cache: 'wikitok.cache.v1',
        scroll: 'wikitok.scroll',
      },
      init() {
        for (const [k, def] of Object.entries({
          [this.keys.likes]: {},
          [this.keys.saves]: {},
          [this.keys.history]: [],
          [this.keys.prefs]: { categories: { 'Science': true, 'History': true, 'Technology': true, 'Culture': true, 'People': true, 'Places': true }, reducedMotion: true },
          [this.keys.cache]: {},
        })) {
          if (LS.get(k) == null) LS.set(k, def);
        }
      },
      like(id, article) {
        const likes = LS.get(this.keys.likes, {}); likes[id] = article; LS.set(this.keys.likes, likes); return likes;
      },
      unlike(id) { const likes = LS.get(this.keys.likes, {}); delete likes[id]; LS.set(this.keys.likes, likes); return likes; },
      isLiked(id) { return !!LS.get(this.keys.likes, {})[id]; },

      save(id, article) { const saves = LS.get(this.keys.saves, {}); saves[id] = article; LS.set(this.keys.saves, saves); return saves; },
      unsave(id) { const saves = LS.get(this.keys.saves, {}); delete saves[id]; LS.set(this.keys.saves, saves); return saves; },
      isSaved(id) { return !!LS.get(this.keys.saves, {})[id]; },

      addHistory(entry) {
        const hist = LS.get(this.keys.history, []);
        if (!hist.find(h => h.id === entry.id)) { hist.unshift({ ...entry, ts: Date.now() }); LS.set(this.keys.history, hist.slice(0, 200)); }
        return hist;
      },

      getPrefs() { return LS.get(this.keys.prefs, { categories: {}, reducedMotion: true }); },
      setPrefs(prefs) { LS.set(this.keys.prefs, prefs); },

      getCache() { return LS.get(this.keys.cache, {}); },
      setCache(cache) { LS.set(this.keys.cache, cache); },
    };

    /* =========================================================
       "wikipedia-api.js" ‚Äî Wikipedia fetch helpers
       REST Summary + Search; modest caching
       ========================================================= */
    const WikiAPI = (() => {
      const REST_BASE = 'https://en.wikipedia.org/api/rest_v1';
      const ACTION_BASE = 'https://en.wikipedia.org/w/api.php';
      const ORIGIN = '&origin=*';

      const cache = Storage.getCache();
      const saveCache = () => Storage.setCache(cache);

      function cacheKey(type, key) { return `${type}:${key}`; }

      async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      }

      async function getRandomSummary() {
        const url = `${REST_BASE}/page/random/summary`;
        const data = await fetchJSON(url);
        return normalizeSummary(data);
      }

      async function getSummaryByTitle(title) {
        const key = cacheKey('summary', title.toLowerCase());
        if (cache[key]) return cache[key];
        const url = `${REST_BASE}/page/summary/${encodeURIComponent(title)}`;
        const data = await fetchJSON(url);
        const norm = normalizeSummary(data);
        cache[key] = norm; saveCache();
        return norm;
      }

      async function searchTitles(query, sroffset = 0) {
        const url = `${ACTION_BASE}?action=query&list=search&format=json&srprop=&srlimit=20&srinfo=&srsearch=${encodeURIComponent(query)}${ORIGIN}&sroffset=${sroffset}`;
        const data = await fetchJSON(url);
        const titles = data?.query?.search?.map(r => r.title) || [];
        const nextOffset = data?.continue?.sroffset ?? null;
        return { titles, nextOffset };
      }

      async function getCategories(pageid) {
        try {
          const url = `${ACTION_BASE}?action=query&format=json&prop=categories&pageids=${pageid}&cllimit=20${ORIGIN}`;
          const data = await fetchJSON(url);
          const pages = data?.query?.pages || {};
          const cats = Object.values(pages)[0]?.categories?.map(c => c.title.replace('Category:', '')) || [];
          return cats;
        } catch { return []; }
      }

      function normalizeSummary(s) {
        const thumb = s.thumbnail?.source || null;
        const img = thumb || s.originalimage?.source || null;
        return {
          id: String(s.pageid || s.titles?.pageid || s.title),
          pageid: s.pageid,
          title: s.title,
          description: s.description || '',
          extract: s.extract || '',
          url: s.content_urls?.desktop?.page || `https://en.wikipedia.org/wiki/${encodeURIComponent(s.title)}`,
          thumbnail: img,
        };
      }

      return { getRandomSummary, getSummaryByTitle, searchTitles, getCategories };
    })();

    /* =========================================================
       "ui-components.js" ‚Äî DOM utilities and rendering
       ========================================================= */
    const UI = (() => {
      const feed = document.getElementById('feed');
      const tpl = document.getElementById('card-template');
      const toast = document.getElementById('toast');

      function el(html) { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstElementChild; }

      function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add('show');
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => toast.classList.remove('show'), 1400);
      }

      function makeTag(label) { return el(`<span class="tag">${label}</span>`); }

      function createPlaceholder(title, tags = []) {
        const primaryTag = tags[0]?.toLowerCase() || 'discover';
        const categoryClass = ['science', 'history', 'technology', 'culture', 'people', 'places'].includes(primaryTag) ? primaryTag : 'discover';
        
        const icons = {
          science: 'üß™',
          history: 'üìú', 
          technology: '‚öôÔ∏è',
          culture: 'üé®',
          people: 'üë§',
          places: 'üåç',
          discover: 'üìö'
        };
        
        const labels = {
          science: 'Science Article',
          history: 'History Article',
          technology: 'Technology Article', 
          culture: 'Culture Article',
          people: 'Biography',
          places: 'Location Article',
          discover: 'Wikipedia Article'
        };
        
        const placeholder = document.createElement('div');
        placeholder.className = `placeholder ${categoryClass}`;
        placeholder.innerHTML = `
          <div class="placeholder-icon">${icons[categoryClass]}</div>
          <div class="placeholder-text">${labels[categoryClass]}</div>
        `;
        placeholder.setAttribute('aria-label', `${labels[categoryClass]}: ${title}`);
        
        return placeholder;
      }

      function articleCard(s, tags = []) {
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.setAttribute('aria-busy', 'true');
        node.dataset.pageid = s.pageid;
        node.dataset.title = s.title;
        node.querySelector('.title').textContent = s.title;
        node.querySelector('.subtitle').textContent = s.description || 'Wikipedia article';
        node.querySelector('.extract').textContent = s.extract?.split('\n').slice(0,2).join(' ') || '';

        const meta = node.querySelector('.meta');
        meta.innerHTML = '';
        meta.append(makeTag('Wikipedia'));
        tags.slice(0, 3).forEach(t => meta.append(makeTag(t)));
        const link = el(`<a class="source" target="_blank" rel="noopener">Read full article ‚Üí</a>`);
        link.href = s.url; link.setAttribute('aria-label', `Read full article on Wikipedia: ${s.title}`);
        meta.append(link);

        // Image
        const media = node.querySelector('.media');
        media.innerHTML = '';
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        wrapper.style.height = '100%';
        
        if (s.thumbnail) {
          // Show skeleton while loading, then real image
          const skeleton = document.createElement('div'); 
          skeleton.className = 'skeleton'; 
          wrapper.append(skeleton);
          
          const pic = document.createElement('picture');
          const img = document.createElement('img');
          img.src = s.thumbnail;
          img.loading = 'lazy';
          img.alt = s.title;
          img.addEventListener('load', () => skeleton.remove());
          pic.append(img);
          wrapper.append(pic);
        } else {
          // Show category-based placeholder instead of black skeleton
          const placeholder = createPlaceholder(s.title, tags);
          wrapper.append(placeholder);
        }
        media.append(wrapper);

        // Actions
        const likeBtn = node.querySelector('.like');
        const saveBtn = node.querySelector('.save');
        const shareBtn = node.querySelector('.share');

        updateToggle(likeBtn, Storage.isLiked(s.pageid));
        updateToggle(saveBtn, Storage.isSaved(s.pageid));

        likeBtn.addEventListener('click', () => {
          const isOn = likeBtn.getAttribute('aria-pressed') === 'true';
          if (isOn) { Storage.unlike(s.pageid); updateToggle(likeBtn, false); showToast('Removed like'); }
          else { Storage.like(s.pageid, s); updateToggle(likeBtn, true); showToast('Liked'); document.dispatchEvent(new CustomEvent('engage', { detail: { type: 'like', article: s } })); }
        });

        saveBtn.addEventListener('click', () => {
          const isOn = saveBtn.getAttribute('aria-pressed') === 'true';
          if (isOn) { Storage.unsave(s.pageid); updateToggle(saveBtn, false); showToast('Removed from Saved'); }
          else { Storage.save(s.pageid, s); updateToggle(saveBtn, true); showToast('Saved'); }
        });

        shareBtn.addEventListener('click', async () => {
          const url = s.url;
          try {
            if (navigator.share) await navigator.share({ title: s.title, text: s.description || s.title, url });
            else { await navigator.clipboard.writeText(url); showToast('Link copied'); }
          } catch {}
        });

        node.addEventListener('focus', () => document.dispatchEvent(new CustomEvent('view', { detail: s })));

        node.removeAttribute('aria-busy');
        return node;
      }

      function updateToggle(btn, on) { btn.setAttribute('aria-pressed', on ? 'true' : 'false'); }

      function clearFeed() { feed.innerHTML = ''; }
      function appendCards(cards) { const frag = document.createDocumentFragment(); cards.forEach(c => frag.append(c)); feed.append(frag); }

      function emptyState(msg) { return el(`<div class="empty">${msg}</div>`); }

      return { articleCard, clearFeed, appendCards, emptyState, showToast };
    })();

    /* =========================================================
       "app.js" ‚Äî Main app logic, virtualization, navigation
       ========================================================= */
    const App = (() => {
      Storage.init();

      const state = {
        mode: 'For You', // or category name, or 'Search', or 'Saved'
        query: '',
        nextOffset: null,
        loading: false,
        activeIndex: 0,
        maxCards: 12,
      };

      const categoryQueries = {
        'Science': 'biology OR physics OR chemistry OR astronomy OR mathematics OR geology',
        'History': 'history OR ancient OR medieval OR revolution OR empire OR dynasty OR archaeology',
        'Technology': 'technology OR computer OR software OR "artificial intelligence" OR robotics OR engineering',
        'Culture': 'culture OR art OR music OR film OR literature OR language OR mythology',
        'People': 'scientist OR inventor OR artist OR philosopher OR leader OR explorer',
        'Places': 'country OR city OR mountain OR river OR landmark OR monument',
      };

      // UI refs
      const chips = [...document.querySelectorAll('.filters .chip')];
      const feed = document.getElementById('feed');
      const searchForm = document.getElementById('search-form');
      const searchInput = document.getElementById('search');
      const randomBtn = document.getElementById('random-btn');
      const savedBtn = document.getElementById('saved-btn');

      const prefsDlg = document.getElementById('prefs');
      const prefsBtn = document.getElementById('prefs-btn');
      const prefsClose = document.getElementById('prefs-close');
      const prefGrid = document.getElementById('pref-grid');
      const prefReducedMotion = document.getElementById('pref-reduced-motion');

      let intersectionObserver;

      function setMode(mode) {
        state.mode = mode;
        state.query = '';
        state.nextOffset = null;
        state.activeIndex = 0;
        chips.forEach(c => c.dataset.active = String(c.dataset.category === mode));
        UI.clearFeed();
        window.scrollTo({ top: 0, behavior: 'instant' });
        if (mode === 'For You') loadForYou(8);
        else if (mode in categoryQueries) loadCategory(mode, 10);
      }

      async function loadForYou(count = 8) {
        if (state.loading) return; state.loading = true;
        const prefs = Storage.getPrefs();
        const weights = Object.entries(prefs.categories).filter(([_, on]) => on).map(([cat]) => [cat, 1]);
        // boost weights from likes
        const likes = Object.values(LS.get(Storage.keys.likes, {}));
        for (const a of likes) {
          const cat = inferHighLevelCategory(a);
          const found = weights.find(w => w[0] === cat);
          if (found) found[1] += 0.6; else weights.push([cat, 0.6]);
        }
        const totalW = weights.reduce((acc, w) => acc + w[1], 0) || 1;

        // Create parallel promises for all articles
        const articlePromises = Array.from({ length: count }, async () => {
          try {
            const pick = weightedPick(weights, totalW); // category
            const { titles } = await WikiAPI.searchTitles(categoryQueries[pick]);
            const title = titles[Math.floor(Math.random() * Math.min(12, titles.length))];
            if (!title) return null;
            
            // Parallel API calls for summary and categories
            const [s, cats] = await Promise.all([
              WikiAPI.getSummaryByTitle(title),
              WikiAPI.getCategories(title.replace(/\s+/g, '_')) // Use title for categories if pageid not available yet
            ]);
            
            return UI.articleCard(s, highLevelTags(cats));
          } catch (error) {
            console.warn('Failed to load article:', error);
            return null;
          }
        });

        // Wait for all articles to load in parallel
        const results = await Promise.all(articlePromises);
        const cards = results.filter(card => card !== null);
        
        UI.appendCards(cards);
        ensureVirtualization();
        attachFeedObserver();
        state.loading = false;
        maybePreloadMore();
      }

      async function loadCategory(category, count = 10, useOffset = false) {
        if (state.loading) return; state.loading = true;
        const query = categoryQueries[category];
        const { titles, nextOffset } = await WikiAPI.searchTitles(query, useOffset ? state.nextOffset : 0);
        state.nextOffset = nextOffset;
        const chosen = shuffle(titles).slice(0, count);
        
        // Create parallel promises for all articles
        const articlePromises = chosen.map(async (title) => {
          try {
            // Parallel API calls for summary and categories
            const [s, cats] = await Promise.all([
              WikiAPI.getSummaryByTitle(title),
              WikiAPI.getCategories(title.replace(/\s+/g, '_')) // Use title initially, will get pageid from summary
            ]);
            
            return UI.articleCard(s, highLevelTags(cats));
          } catch (error) {
            console.warn('Failed to load article:', title, error);
            return null;
          }
        });

        // Wait for all articles to load in parallel
        const results = await Promise.all(articlePromises);
        const cards = results.filter(card => card !== null);
        
        UI.appendCards(cards);
        ensureVirtualization();
        attachFeedObserver();
        state.loading = false;
        maybePreloadMore();
      }

      async function loadSearch(query, more = false) {
        if (state.loading) return; state.loading = true;
        if (!more) { UI.clearFeed(); state.nextOffset = null; }
        const { titles, nextOffset } = await WikiAPI.searchTitles(query, more ? state.nextOffset : 0);
        state.nextOffset = nextOffset;
        if (!titles.length) { 
          feed.append(UI.emptyState('No results. Try a broader search.'));
          state.loading = false;
          return;
        }
        
        const searchTitles = titles.slice(0, 12);
        
        // Create parallel promises for all search results
        const articlePromises = searchTitles.map(async (title) => {
          try {
            // Parallel API calls for summary and categories
            const [s, cats] = await Promise.all([
              WikiAPI.getSummaryByTitle(title),
              WikiAPI.getCategories(title.replace(/\s+/g, '_')) // Use title initially, will get pageid from summary
            ]);
            
            return UI.articleCard(s, highLevelTags(cats));
          } catch (error) {
            console.warn('Failed to load search result:', title, error);
            return null;
          }
        });

        // Wait for all articles to load in parallel
        const results = await Promise.all(articlePromises);
        const cards = results.filter(card => card !== null);
        
        UI.appendCards(cards);
        ensureVirtualization();
        attachFeedObserver();
        state.loading = false;
        maybePreloadMore();
      }

      async function loadRandom() {
        if (state.loading) return; state.loading = true;
        const cards = [];
        for (let i = 0; i < 3; i++) {
          const s = await WikiAPI.getRandomSummary();
          const cats = await WikiAPI.getCategories(s.pageid);
          cards.push(UI.articleCard(s, highLevelTags(cats)));
        }
        UI.appendCards(cards);
        ensureVirtualization();
        attachFeedObserver();
        state.loading = false;
        maybePreloadMore();
      }

      function attachFeedObserver() {
        intersectionObserver?.disconnect();
        const cards = [...document.querySelectorAll('article.card')];
        const options = { root: null, rootMargin: '0px', threshold: 0.6 };
        intersectionObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const idx = cards.indexOf(entry.target);
            if (entry.isIntersecting && idx !== -1) {
              state.activeIndex = idx;
              const s = serializeCard(entry.target);
              Storage.addHistory({ id: s.pageid, title: s.title, url: s.url });
            }
          });
        }, options);
        cards.forEach(c => intersectionObserver.observe(c));
      }

      function maybePreloadMore() {
        const nearBottom = window.innerHeight + window.scrollY > document.body.offsetHeight - 1400;
        if (nearBottom) triggerLoadMore();
      }

      async function triggerLoadMore() {
        if (state.loading) return;
        if (state.mode === 'For You') return loadForYou(6);
        if (state.mode in categoryQueries) return loadCategory(state.mode, 8, true);
        if (state.mode === 'Search' && state.query) return loadSearch(state.query, true);
      }

      function serializeCard(node) {
        return {
          pageid: Number(node.dataset.pageid),
          title: node.dataset.title,
          url: node.querySelector('.meta a.source')?.href || '',
        };
      }

      function ensureVirtualization() {
        const cards = [...document.querySelectorAll('article.card')];
        if (cards.length <= state.maxCards) return;
        const start = Math.max(0, state.activeIndex - Math.floor(state.maxCards / 2));
        const end = start + state.maxCards;
        cards.forEach((c, i) => { if (i < start - 2 || i > end + 2) c.remove(); });
      }

      // High-level tags based on raw categories
      function highLevelTags(cats) {
        const tags = new Set();
        const map = [
          ['Science', /biology|physics|chemistry|astronomy|mathematics|geology|scientific|genetics|ecology/i],
          ['History', /history|war|empire|dynasty|kingdom|revolution|ancient|medieval|archaeology/i],
          ['Technology', /technology|computer|software|internet|robot|engineering|ai|electronics|telecommunications/i],
          ['Culture', /culture|art|music|film|literature|language|religion|mythology|festival/i],
          ['People', /people|biography|births|deaths|politicians|artists|scientists|philosophers|explorers/i],
          ['Places', /places|countries|cities|mountains|rivers|lakes|landmarks|geography/i],
        ];
        for (const c of cats) { for (const [label, re] of map) if (re.test(c)) tags.add(label); }
        if (!tags.size) tags.add('Discover');
        return [...tags];
      }

      function inferHighLevelCategory(article) {
        const cats = []; // If we had categories, but for likes we guess from description/title
        const text = `${article?.title} ${article?.description}`.toLowerCase();
        if (/biology|physics|chemistry|astronomy|math|geology/.test(text)) return 'Science';
        if (/history|war|empire|dynasty|ancient|medieval|archaeolog/.test(text)) return 'History';
        if (/technology|computer|software|ai|robot|engineering|internet/.test(text)) return 'Technology';
        if (/art|music|film|literature|language|culture|mytholog/.test(text)) return 'Culture';
        if (/king|queen|scientist|inventor|artist|philosopher|leader|explorer|born|died/.test(text)) return 'People';
        if (/country|city|mountain|river|landmark|valley|province/.test(text)) return 'Places';
        return 'Discover';
      }

      function weightedPick(weights, total) {
        let r = Math.random() * total;
        for (const [k, w] of weights) { if ((r -= w) <= 0) return k; }
        return weights[0]?.[0] || 'Science';
      }

      function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

      // Keyboard navigation
      function goNext() { const cards = [...document.querySelectorAll('article.card')]; const i = Math.min(cards.length - 1, state.activeIndex + 1); cards[i]?.scrollIntoView({ behavior: 'smooth', block: 'start' }); cards[i]?.focus(); }
      function goPrev() { const cards = [...document.querySelectorAll('article.card')]; const i = Math.max(0, state.activeIndex - 1); cards[i]?.scrollIntoView({ behavior: 'smooth', block: 'start' }); cards[i]?.focus(); }

      // Bindings
      chips.forEach(c => c.addEventListener('click', () => setMode(c.dataset.category)));

      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const q = searchInput.value.trim();
        if (!q) return;
        state.mode = 'Search'; state.query = q; chips.forEach(c => c.dataset.active = 'false');
        loadSearch(q);
      });

      randomBtn.addEventListener('click', () => { state.mode = 'Random'; chips.forEach(c => c.dataset.active = 'false'); loadRandom(); });
      savedBtn.addEventListener('click', () => {
        UI.clearFeed(); state.mode = 'Saved'; chips.forEach(c => c.dataset.active = 'false');
        const saves = Object.values(LS.get(Storage.keys.saves, {}));
        if (!saves.length) { feed.append(UI.emptyState('No saved articles yet. Tap Save on any card.')); return; }
        const cards = saves.map(s => UI.articleCard(s, ['Saved']));
        UI.appendCards(cards);
        attachFeedObserver();
      });

      document.addEventListener('view', (e) => { const a = e.detail; Storage.addHistory({ id: a.pageid, title: a.title, url: a.url }); });
      document.addEventListener('engage', (e) => { /* could refine the algorithm here */ });

      window.addEventListener('scroll', maybePreloadMore, { passive: true });
      window.addEventListener('resize', ensureVirtualization);

      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement !== searchInput) { e.preventDefault(); searchInput.focus(); return; }
        if (e.key === ' ' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
          e.preventDefault(); if (e.shiftKey) goPrev(); else goNext(); return;
        }
        if ((e.key === 'ArrowDown' || e.key === 'j') && !e.metaKey && !e.ctrlKey) { e.preventDefault(); goNext(); return; }
        if ((e.key === 'ArrowUp' || e.key === 'k') && !e.metaKey && !e.ctrlKey) { e.preventDefault(); goPrev(); return; }
        if (e.key.toLowerCase() === 'r') { e.preventDefault(); randomBtn.click(); return; }
        if (e.key.toLowerCase() === 'l') { e.preventDefault(); toggleActiveButton('.like'); return; }
        if (e.key.toLowerCase() === 'b') { e.preventDefault(); toggleActiveButton('.save'); return; }
      });

      function toggleActiveButton(sel) {
        const cards = [...document.querySelectorAll('article.card')];
        const btn = cards[state.activeIndex]?.querySelector(sel);
        btn?.click();
      }

      // Preferences modal
      prefsBtn.addEventListener('click', () => openPrefs());
      prefsClose.addEventListener('click', () => prefsDlg.close());
      prefsDlg.addEventListener('close', () => savePrefsFromUI());

      function openPrefs() {
        const prefs = Storage.getPrefs();
        prefGrid.innerHTML = '';
        for (const cat of Object.keys(categoryQueries)) {
          const id = `pref-${cat}`;
          const row = document.createElement('label');
          row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.gap = '10px';
          row.innerHTML = `<input type="checkbox" id="${id}" ${prefs.categories[cat] ? 'checked' : ''}/> ${cat}`;
          prefGrid.append(row);
        }
        prefReducedMotion.checked = !!prefs.reducedMotion;
        prefsDlg.showModal();
      }

      function savePrefsFromUI() {
        const categories = {};
        for (const cat of Object.keys(categoryQueries)) {
          const el = document.getElementById(`pref-${cat}`);
          categories[cat] = !!el?.checked;
        }
        const prefs = { categories, reducedMotion: !!prefReducedMotion.checked };
        Storage.setPrefs(prefs);
        UI.showToast('Preferences saved');
        if (state.mode === 'For You') { UI.clearFeed(); loadForYou(8); }
      }

      // Restore previous scroll position (per session)
      window.addEventListener('beforeunload', () => LS.sset(Storage.keys.scroll, { y: window.scrollY }));
      const last = LS.sget(Storage.keys.scroll, null); if (last?.y) setTimeout(() => window.scrollTo({ top: last.y, behavior: 'instant' }), 0);

      // Init
      setMode('For You');
    
      return { setMode };
    })();
  </script>
</body>
</html>
